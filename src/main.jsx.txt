import React, { useState, useEffect, useMemo } from 'react';
import { 
  BookOpen, Users, UserCheck, FileText, 
  BarChart2, Lightbulb, ShieldCheck, ChevronRight, ChevronLeft, 
  X, Sparkles, Loader2, RotateCcw, Link as LinkIcon, FolderOpen, Download
} from 'lucide-react';

// --- CONFIGURACIÓN Y API ---
const apiKey = ""; // Tu clave de Gemini aquí

const callGeminiAPI = async (prompt) => {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
      }
    );
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar respuesta.";
  } catch (error) { return null; }
};

// --- DATOS DE FACTORES ---
const FACTORS = [
  {
    id: 1, title: "Proyecto educativo del programa e identidad institucional", icon: BookOpen,
    characteristics: [{ id: 1, title: "Proyecto educativo del programa" }, { id: 2, title: "Relevancia académica y pertinencia social" }]
  },
  {
    id: 2, title: "Comunidad de estudiantes", icon: Users,
    characteristics: [{ id: 3, title: "Incidencia de formación integral" }, { id: 4, title: "Acompañamiento a estudiantes" }]
  },
  {
    id: 3, title: "Comunidad de profesores", icon: UserCheck,
    characteristics: [{ id: 5, title: "Procesos de selección y vinculación" }, { id: 6, title: "Estatuto y desarrollo profesoral" }]
  }
  // Puedes expandir hasta los 12 factores aquí...
];

// --- COMPONENTES ---
const Dashboard = ({ assessments, programConfig, setProgramConfig, onNavigate, onExport }) => {
  const scores = useMemo(() => FACTORS.map(f => {
    let total = 0, count = 0;
    f.characteristics.forEach(c => {
      const a = assessments[c.id];
      if (a && a.level > 0) { total += (a.level * 25); count++; }
    });
    return { ...f, avg: count > 0 ? total / count : 0 };
  }), [assessments]);

  return (
    <div className="p-10 max-w-5xl mx-auto space-y-8 animate-in fade-in">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-black text-slate-800 tracking-tighter">TABLERO DE CONTROL</h2>
        <button onClick={onExport} className="bg-green-600 text-white px-6 py-3 rounded-2xl font-bold hover:bg-green-700 transition-all flex items-center shadow-lg">
          <Download size={18} className="mr-2" /> EXPORTAR REPORTE
        </button>
      </div>

      <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-6">
        <h3 className="font-bold text-slate-400 uppercase text-xs tracking-widest flex items-center"><FolderOpen size={16} className="mr-2"/> Datos del Programa</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" placeholder="Nombre del Programa" className="p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-medium" value={programConfig.name} onChange={e => setProgramConfig({...programConfig, name: e.target.value})} />
          <input type="text" placeholder="URL Carpeta Raíz (Drive/SharePoint)" className="p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-medium text-blue-600" value={programConfig.rootFolder} onChange={e => setProgramConfig({...programConfig, rootFolder: e.target.value})} />
        </div>
      </div>

      <div className="grid grid-cols-1 gap-4">
        {scores.map(f => (
          <div key={f.id} onClick={() => onNavigate(f.id-1)} className="bg-white p-6 rounded-3xl border border-slate-100 hover:border-blue-200 cursor-pointer transition-all group">
            <div className="flex justify-between items-center mb-4">
              <span className="font-bold text-slate-700 group-hover:text-blue-600 transition-colors">FACTOR {f.id}: {f.title}</span>
              <span className="font-black text-blue-600">{f.avg.toFixed(0)}%</span>
            </div>
            <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
              <div className="h-full bg-blue-600 transition-all duration-1000" style={{width: `${f.avg}%`}} />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default function App() {
  const [view, setView] = useState('assessment');
  const [activeFactorIndex, setActiveFactorIndex] = useState(0);
  const [activeCharIndex, setActiveCharIndex] = useState(0);
  const [assessments, setAssessments] = useState({});
  const [programConfig, setProgramConfig] = useState({ name: "", rootFolder: "" });
  const [aiLoading, setAiLoading] = useState(false);
  const [aiContent, setAiContent] = useState(null);

  useEffect(() => {
    const d = localStorage.getItem('maac_v3_data'), c = localStorage.getItem('maac_v3_conf');
    if (d) setAssessments(JSON.parse(d)); if (c) setProgramConfig(JSON.parse(c));
  }, []);

  useEffect(() => {
    localStorage.setItem('maac_v3_data', JSON.stringify(assessments));
    localStorage.setItem('maac_v3_conf', JSON.stringify(programConfig));
  }, [assessments, programConfig]);

  const activeF = FACTORS[activeFactorIndex], activeC = activeF.characteristics[activeCharIndex];
  const current = assessments[activeC.id] || { level: 0, observations: "", evidenceLink: "" };

  const handleReset = () => {
    if (window.confirm("¿Borrar todo?")) { setAssessments({}); setProgramConfig({name:"", rootFolder:""}); localStorage.clear(); }
  };

  const handleAI = async () => {
    setAiLoading(true);
    const text = await callGeminiAPI(`Como experto MAAC Colombia, sugiere evidencias para "${activeC.title}" en nivel ${current.level}.`);
    if (text) setAiContent(text);
    setAiLoading(false);
  };

  return (
    <div className="flex h-screen bg-slate-50 text-slate-900 overflow-hidden font-sans">
      {aiContent && <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-6"><div className="bg-white rounded-[2rem] p-10 max-w-2xl w-full max-h-[80vh] overflow-y-auto relative"><button onClick={()=>setAiContent(null)} className="absolute top-6 right-6 text-slate-400 hover:text-slate-900"><X/></button><h3 className="text-2xl font-black mb-6 flex items-center text-blue-600"><Sparkles className="mr-2"/> Guía del Mentor</h3><div className="prose prose-slate">{aiContent}</div></div></div>}

      <aside className="w-80 bg-white border-r flex flex-col p-6 space-y-8">
        <div className="py-4"><h1 className="text-2xl font-black tracking-tighter text-blue-600">AUTO-MAAC</h1></div>
        <nav className="flex-1 space-y-2 overflow-y-auto">
          <button onClick={()=>setView('dashboard')} className={`w-full p-4 rounded-2xl flex items-center font-bold text-sm ${view === 'dashboard' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-50'}`}><BarChart2 size={18} className="mr-3"/> Dashboard</button>
          <div className="h-px bg-slate-100 my-4" />
          {FACTORS.map((f, i) => (
            <button key={f.id} onClick={()=>{setActiveFactorIndex(i); setActiveCharIndex(0); setView('assessment');}} className={`w-full text-left p-4 rounded-2xl text-xs font-black transition-all ${activeFactorIndex === i && view === 'assessment' ? 'bg-slate-900 text-white' : 'text-slate-400 hover:bg-slate-50'}`}>FACTOR {f.id}</button>
          ))}
        </nav>
        <button onClick={handleReset} className="p-4 text-red-500 font-bold text-xs flex items-center justify-center hover:bg-red-50 rounded-2xl"><RotateCcw size={16} className="mr-2"/> REINICIAR</button>
      </aside>

      <main className="flex-1 flex flex-col overflow-hidden">
        {view === 'assessment' ? (
          <>
            <header className="p-12 bg-white border-b flex justify-between items-end">
              <div><span className="text-blue-600 font-black text-xs tracking-widest block mb-2 uppercase">Característica {activeC.id}</span><h2 className="text-4xl font-black text-slate-800 tracking-tight">{activeC.title}</h2></div>
              <div className="text-right"><span className="text-5xl font-black text-blue-600">{current.level*25}%</span><p className="text-[10px] font-black text-slate-300 uppercase">Madurez</p></div>
            </header>
            <div className="flex-1 overflow-y-auto p-12 bg-slate-50 space-y-8">
              <div className="max-w-3xl mx-auto space-y-8">
                <div className="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                  <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Nivel de Calidad</h3>
                  <div className="flex gap-4">{[0,1,2,3,4].map(n=>(<button key={n} onClick={()=>setAssessments({...assessments, [activeC.id]: {...current, level:n}})} className={`flex-1 py-6 rounded-2xl border-2 font-black text-xl transition-all ${current.level===n ? 'border-blue-600 bg-blue-50 text-blue-600 shadow-lg scale-105' : 'border-slate-100 text-slate-200'}`}>{n}</button>))}</div>
                </div>
                <div className="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                  <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 flex items-center"><LinkIcon size={14} className="mr-2"/> URL Carpeta de Evidencia</h3>
                  <input type="text" className="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-600 text-blue-600 font-medium" placeholder="Pegue el link específico para esta característica aquí..." value={current.evidenceLink} onChange={e=>setAssessments({...assessments, [activeC.id]: {...current, evidenceLink:e.target.value}})} />
                </div>
                <div className="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                  <div className="flex justify-between items-center mb-6"><h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">Hallazgos y Análisis</h3><button onClick={handleAI} disabled={aiLoading} className="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-black flex items-center hover:bg-blue-600 transition-all">{aiLoading ? <Loader2 className="animate-spin mr-2" size={14}/> : <Sparkles className="mr-2 text-yellow-400" size={14}/>} IA MENTOR</button></div>
                  <textarea className="w-full h-64 bg-slate-50 border-none rounded-3xl p-6 outline-none focus:ring-2 focus:ring-blue-600 font-medium text-slate-600" placeholder="Análisis cualitativo..." value={current.observations} onChange={e=>setAssessments({...assessments, [activeC.id]: {...current, observations:e.target.value}})} />
                </div>
              </div>
            </div>
            <footer className="p-8 bg-white border-t flex justify-between px-12">
              <button onClick={()=>setActiveCharIndex(Math.max(0, activeCharIndex-1))} className="font-black text-slate-400 hover:text-slate-800 transition-all flex items-center">ANTERIOR</button>
              <button onClick={()=>{ if(activeCharIndex < activeF.characteristics.length-1) setActiveCharIndex(activeCharIndex+1); else if(activeFactorIndex < FACTORS.length-1) { setActiveFactorIndex(activeFactorIndex+1); setActiveCharIndex(0); } else setView('dashboard'); }} className="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all">SIGUIENTE</button>
            </footer>
          </>
        ) : (
          <Dashboard assessments={assessments} programConfig={programConfig} setProgramConfig={setProgramConfig} onNavigate={i=>{setActiveFactorIndex(i); setActiveCharIndex(0); setView('assessment');}} onExport={()=>{}} />
        )}
      </main>
    </div>
  );
}